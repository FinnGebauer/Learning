
/* create a temporary table with daily revenue */
with daily_revenue as (
  select
    date(created_at) as dt,
    round(sum(price), 2) as rev
  from purchases
  where refunded_at is null
  group by 1
),
/* create a temporary table with daily players based on distinct user_ids */
daily_players as (
  select
  date(created_at) as dt,
  count(distinct user_id) as players
  from gameplays
  group by 1
)
/*calculate ARPU based on the two temporary tables */
select
  daily_revenue.dt,
  daily_revenue.rev / daily_players.players
from daily_revenue
  join daily_players using (dt);
